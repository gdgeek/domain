{% extends "base.html" %}

{% block title %}{{ '编辑域名' if domain else '添加域名' }} - 域名配置管理{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.3/dist/jsoneditor.min.css">
<div class="card">
    <div class="card-header">
        <h1 class="card-title">{{ '编辑域名' if domain else '添加域名' }}</h1>
    </div>
    
    <form method="POST">
        <div class="form-group">
            <label for="name">域名 *</label>
            <input type="text" id="name" name="name" class="form-control" 
                   value="{{ domain.name if domain else '' }}" 
                   placeholder="example.com" required>
        </div>
        
        <div class="form-group">
            <label for="description">描述</label>
            <input type="text" id="description" name="description" class="form-control" 
                   value="{{ domain.description if domain else '' }}"
                   placeholder="可选的描述信息">
        </div>

        <div class="form-group">
            <label for="default_config">默认配置 (JSON，语言无关)</label>
            <div id="default-config-editor" class="json-editor-container"></div>
            <div class="mt-1">
                <button type="button" id="format-default-config-btn" class="btn btn-secondary btn-sm">一键格式化 JSON</button>
            </div>
            <textarea id="default_config" name="default_config" class="form-control"
                      style="display: none;" required>{{ domain.default_config | tojson(indent=2) if domain and domain.default_config else '{\n  "site_name": "",\n  "logo": "",\n  "theme": "default"\n}' }}</textarea>
            <small class="text-muted">这里填写网站通用参数，查询时会与语言配置合并（语言配置同名字段优先）</small>
        </div>

        <div class="form-group">
            <label for="fallback_domain_id">回退域名</label>
            <select id="fallback_domain_id" name="fallback_domain_id" class="form-control">
                <option value="">-- 无 --</option>
                {% for d in all_domains %}
                    {% if not domain or d.id != domain.id %}
                    <option value="{{ d.id }}" 
                            {{ 'selected' if domain and domain.fallback_domain_id == d.id else '' }}>
                        {{ d.name }}
                    </option>
                    {% endif %}
                {% endfor %}
            </select>
            <small class="text-muted">当此域名没有配置时，自动使用回退域名的配置</small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_active" 
                       {{ 'checked' if (domain and domain.is_active) or not domain else '' }}>
                启用
            </label>
        </div>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">保存</button>
            <a href="{{ url_for('admin.domain_list') }}" class="btn btn-secondary">取消</a>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.3/dist/jsoneditor.min.js"></script>
<script>
var defaultConfigTextarea = document.getElementById('default_config');
var defaultConfigEditorContainer = document.getElementById('default-config-editor');
var defaultConfigInitialText = defaultConfigTextarea.value;
var defaultConfigInitialData;

try {
    defaultConfigInitialData = JSON.parse(defaultConfigInitialText);
} catch (err) {
    defaultConfigInitialData = {};
}

var defaultConfigEditor = new JSONEditor(defaultConfigEditorContainer, {
    mode: 'code',
    modes: ['code', 'tree', 'view'],
    onChangeText: function (jsonText) {
        defaultConfigTextarea.value = jsonText;
    }
}, defaultConfigInitialData);

document.getElementById('format-default-config-btn').addEventListener('click', function() {
    try {
        var jsonText = defaultConfigEditor.getText();
        var parsed = JSON.parse(jsonText);
        defaultConfigEditor.set(parsed);
        defaultConfigTextarea.value = JSON.stringify(parsed, null, 2);
    } catch (err) {
        alert('默认配置格式化失败: ' + err.message);
    }
});

document.querySelector('form').addEventListener('submit', function(e) {
    try {
        var jsonText = defaultConfigEditor.getText();
        var parsed = JSON.parse(jsonText);
        defaultConfigTextarea.value = JSON.stringify(parsed, null, 2);
    } catch (err) {
        e.preventDefault();
        alert('默认配置必须是有效的 JSON 格式: ' + err.message);
    }
});
</script>
{% endblock %}
